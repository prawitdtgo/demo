version: '3.8'
services:
  app:
    build:
      context: .
      dockerfile: Dockerfile-app
    image: 127.0.0.1:5000/demo-app:${API_VERSION}
    restart: on-failure
    environment:
      - API_VERSION=${API_VERSION}
      - API_PREFIX=${API_PREFIX}
      - API_BASE_URL=https://${HOST}${API_PREFIX}
      - MONGO_HOST=mongo
      - MONGO_DATABASE_NAME=demo
      - MONGO_DATABASE_USERNAME_FILE=/run/secrets/mongo-application-username
      - MONGO_DATABASE_PASSWORD_FILE=/run/secrets/mongo-application-password
    secrets:
      - mongo-application-username
      - mongo-application-password
  mongo:
    build:
      context: .
      dockerfile: Dockerfile-mongo
    image: 127.0.0.1:5000/demo-mongo:${API_VERSION}
    restart: on-failure
    environment:
      - MONGO_INITDB_ROOT_USERNAME_FILE=/run/secrets/mongo-root-username
      - MONGO_INITDB_ROOT_PASSWORD_FILE=/run/secrets/mongo-root-password
      - MONGO_INITDB_DATABASE=demo
      - MONGO_DATABASE_USERNAME_FILE=/run/secrets/mongo-application-username
      - MONGO_DATABASE_PASSWORD_FILE=/run/secrets/mongo-application-password
    volumes:
      - mongo-data:/data/db
    secrets:
      - mongo-root-username
      - mongo-root-password
      - mongo-application-username
      - mongo-application-password
volumes:
  mongo-data:
secrets:
  mongo-root-username:
    file: mongodb-credentials/root-username.txt
  mongo-root-password:
    file: mongodb-credentials/root-password.txt
  mongo-application-username:
    file: mongodb-credentials/application-username.txt
  mongo-application-password:
    file: mongodb-credentials/application-password.txt
networks:
  default:
    external: true
    name: reverse-proxy
